<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEAY1 World - ‡πÄ‡∏Å‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÑ‡∏ó‡∏¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            overflow-x: hidden;
            margin: 0;
        }
        .bounce-in {
            animation: bounceIn 0.8s cubic-bezier(0.36, 0, 0.66, -0.56) both;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        .bg-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%233b82f6' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2v-4h4v-2h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2v-4h4v-2H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .success-bg {
            background: radial-gradient(circle, #fef9c3 0%, #fef08a 100%);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-pattern min-h-screen">

    <!-- Top Bar -->
    <div id="top-bar" class="fixed top-0 left-0 right-0 p-4 flex justify-between items-center z-40 hidden">
        <button onclick="confirmExit()" class="bg-white/80 p-2 rounded-full shadow-sm hover:bg-white transition px-4 font-bold text-gray-600">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <div class="flex items-center gap-4">
            <div id="progress-container" class="hidden md:flex flex-col items-end mr-2">
                <span class="text-xs font-bold text-blue-600 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (<span id="progress-text">0/20</span>)</span>
                <div class="w-48 h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="progress-fill" class="progress-bar-fill h-full bg-blue-500" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-full font-bold shadow-md flex items-center gap-2">
                ü™ô <span id="score-display">0</span>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="min-h-screen flex flex-col items-center justify-center text-center p-8 transition-opacity duration-500">
        <div class="mb-6 float-animation">
            <h1 class="text-8xl font-black text-blue-600 tracking-tighter drop-shadow-lg">
                NEAY<span class="text-orange-500">1</span>
            </h1>
            <p class="text-xl text-gray-600 mt-2 font-light">‡πÑ‡∏î‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ ‡πÅ‡∏•‡∏∞ ‡∏™‡∏ô‡∏∏‡∏Å‡πÑ‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÜ‡∏Å‡∏±‡∏ô‡∏ô‡∏∞ ‚ú®</p>
        </div>

        <div class="space-y-4 bounce-in" style="animation-delay: 0.2s;">
            <button onclick="showGrades()" class="bg-orange-500 hover:bg-orange-600 text-white text-2xl px-12 py-4 rounded-full shadow-xl transform transition hover:scale-105 active:scale-95 font-bold">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à 20 ‡∏Ç‡πâ‡∏≠! üöÄ
            </button>
            <div class="flex justify-center gap-4 mt-8">
                <button onclick="openChat()" class="bg-blue-100 text-blue-600 p-4 rounded-2xl shadow-sm hover:bg-blue-200 transition border-b-4 border-blue-300 font-bold">
                    ‚ú® ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö AI Tutor
                </button>
            </div>
        </div>
    </div>

    <!-- Grade Selection -->
    <div id="grade-screen" class="hidden min-h-screen flex flex-col items-center justify-center max-w-6xl mx-auto px-6 py-12 transition-all duration-500">
        <div class="text-center mb-12">
            <h2 class="text-4xl font-bold text-blue-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
            <p class="text-gray-500">‡∏•‡∏∏‡∏¢‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢ ‚ú®</p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
            <div onclick="startMission('‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 1-3')" class="bg-white p-6 rounded-3xl shadow-xl hover:shadow-2xl cursor-pointer transform transition hover:-translate-y-2 border-b-8 border-green-500 text-center">
                <div class="text-6xl mb-4">üé®</div>
                <h3 class="text-xl font-bold text-green-600 mb-2">‡∏≠.1 - ‡∏≠.3</h3>
                <button class="w-full mt-4 py-2 rounded-xl bg-green-50 text-green-700 font-bold text-sm">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
            </div>

            <div onclick="startMission('‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1-3')" class="bg-white p-6 rounded-3xl shadow-xl hover:shadow-2xl cursor-pointer transform transition hover:-translate-y-2 border-b-8 border-blue-400 text-center">
                <div class="text-6xl mb-4">üìö</div>
                <h3 class="text-xl font-bold text-blue-500 mb-2">‡∏õ.1 - ‡∏õ.3</h3>
                <button class="w-full mt-4 py-2 rounded-xl bg-blue-50 text-blue-700 font-bold text-sm">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
            </div>

            <div onclick="startMission('‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4-6')" class="bg-white p-6 rounded-3xl shadow-xl hover:shadow-2xl cursor-pointer transform transition hover:-translate-y-2 border-b-8 border-orange-400 text-center">
                <div class="text-6xl mb-4">üß©</div>
                <h3 class="text-xl font-bold text-orange-500 mb-2">‡∏õ.4 - ‡∏õ.6</h3>
                <button class="w-full mt-4 py-2 rounded-xl bg-orange-50 text-orange-700 font-bold text-sm">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
            </div>

            <div onclick="startMission('‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1-3')" class="bg-white p-6 rounded-3xl shadow-xl hover:shadow-2xl cursor-pointer transform transition hover:-translate-y-2 border-b-8 border-purple-500 text-center">
                <div class="text-6xl mb-4">üöÄ</div>
                <h3 class="text-xl font-bold text-purple-600 mb-2">‡∏°.1 - ‡∏°.3</h3>
                <button class="w-full mt-4 py-2 rounded-xl bg-purple-50 text-purple-700 font-bold text-sm">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
            </div>
        </div>

        <div class="mt-12">
            <button onclick="showStart()" class="text-gray-500 hover:text-blue-600 transition">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </div>
    </div>

    <!-- AI Quest Display Modal -->
    <div id="quest-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
        <!-- Question Card -->
        <div id="quest-card" class="bg-white rounded-3xl max-w-lg w-full p-8 shadow-2xl relative transition-all">
            <div id="quest-loading" class="flex flex-col items-center py-10">
                <div class="spinner"></div>
                <p class="mt-4 text-blue-600 font-bold text-center">‚ú® ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì...</p>
            </div>
            <div id="quest-content" class="hidden">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-2">
                        <span id="subject-icon" class="text-3xl">üéØ</span>
                        <h3 id="quest-title" class="text-2xl font-bold text-gray-800"></h3>
                    </div>
                    <button onclick="getAIHint()" id="hint-btn" class="text-xs bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full border border-yellow-200 hover:bg-yellow-200 transition">
                        ‚ú® ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡∏à‡∏≤‡∏Å‡∏û‡∏µ‡πà AI
                    </button>
                </div>
                
                <div id="hint-box" class="hidden mb-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 text-sm rounded-r-lg italic"></div>

                <div class="bg-blue-50 p-6 rounded-2xl mb-6 text-gray-700 text-lg font-medium" id="quest-body"></div>
                <div class="grid grid-cols-1 gap-3" id="quest-options"></div>
                
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
                <button onclick="confirmExit()" class="mt-8 w-full py-3 text-red-400 hover:text-red-600 font-bold transition text-sm border-2 border-dashed border-red-100 rounded-xl">
                    üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏±‡∏ô
                </button>
            </div>
        </div>

        <!-- Success Result View -->
        <div id="success-view" class="hidden bg-white rounded-3xl max-w-lg w-full p-10 shadow-2xl relative text-center bounce-in overflow-hidden">
            <div class="absolute inset-0 success-bg opacity-30 -z-10"></div>
            <div class="text-7xl mb-4">üéâ</div>
            <h3 class="text-3xl font-bold text-orange-600 mb-2">‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢!</h3>
            <p id="success-encouragement" class="text-gray-700 mb-4 text-lg"></p>
            
            <div id="ai-story-box" class="hidden mb-6 p-4 bg-white/60 rounded-xl border border-orange-200 text-sm text-gray-600 text-left italic max-h-32 overflow-y-auto">
                <span class="font-bold text-orange-600 block mb-1">üìñ ‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏±‡πâ‡∏ô:</span>
                <span id="ai-story-text"></span>
            </div>

            <div class="bg-yellow-100 text-yellow-700 py-3 rounded-2xl font-bold text-xl mb-6">
                ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö +10 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏õ‡∏±‡∏ç‡∏ç‡∏≤ ü™ô
            </div>
            
            <button id="next-quest-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xl py-4 rounded-2xl shadow-lg font-bold transition">
                ‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ (Next) ‚ûî
            </button>
        </div>

        <!-- Mission Completed View -->
        <div id="mission-complete-view" class="hidden bg-white rounded-3xl max-w-lg w-full p-10 shadow-2xl relative text-center bounce-in overflow-hidden border-4 border-yellow-400">
            <div class="text-8xl mb-4 animate-bounce">üèÜ</div>
            <h3 class="text-4xl font-black text-blue-600 mb-2">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
            <p class="text-gray-600 mb-6 text-xl">‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö 20 ‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏¢!</p>
            
            <div class="bg-blue-50 p-6 rounded-2xl mb-8">
                <p class="text-gray-500 text-sm mb-1 uppercase tracking-widest font-bold">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</p>
                <div class="text-5xl font-bold text-blue-700" id="final-score-display">0</div>
                <p class="text-blue-600 text-sm mt-1">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏∞‡∏™‡∏°‡πÑ‡∏î‡πâ</p>
            </div>

            <div id="ai-summary-feedback" class="mb-8 p-4 bg-yellow-50 rounded-xl text-sm text-yellow-800 italic border border-yellow-100">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏µ‡πà AI ‡∏™‡∏£‡∏∏‡∏õ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...
            </div>

            <button onclick="showStart()" class="w-full bg-orange-500 hover:bg-orange-600 text-white text-xl py-4 rounded-2xl shadow-lg font-bold transition">
                ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </button>
        </div>
    </div>

    <!-- AI Tutor Floating Chat -->
    <div id="ai-chat" class="hidden fixed bottom-6 right-6 w-80 md:w-96 z-50 flex flex-col shadow-2xl rounded-2xl overflow-hidden glass-panel border-2 border-blue-200">
        <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
            <span class="font-bold flex items-center gap-2">‚ú® NEAY1 AI Tutor</span>
            <button onclick="closeChat()" class="text-white/80 hover:text-white">‚úï</button>
        </div>
        <div id="chat-messages" class="h-80 overflow-y-auto p-4 space-y-4 bg-white/50 text-sm">
            <div class="bg-blue-100 p-3 rounded-2xl rounded-tl-none text-blue-800">
                ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞ ‡∏û‡∏µ‡πà AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏à‡πâ‡∏≤!
            </div>
        </div>
        <div id="chat-loading-indicator" class="hidden px-4 py-2 text-xs text-blue-500 font-bold animate-pulse">‡∏û‡∏µ‡πà AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå...</div>
        <div class="p-4 bg-white border-t border-gray-100 flex gap-2">
            <input id="chat-input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°..." class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="sendMessage()" class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
            </button>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyCcTir24pLVPpEBKgNmMIHyoTfVGI6ppvo";
        let currentScore = 0;
        let lastLevel = '‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 1-3';
        let currentQuestData = null;
        let currentQuestionNumber = 0;
        const TOTAL_QUESTIONS = 20;

        function showGrades() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('grade-screen').classList.remove('hidden');
            document.getElementById('top-bar').classList.remove('hidden');
            document.getElementById('progress-container').classList.add('hidden');
        }

        function showStart() {
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
            document.getElementById('grade-screen').classList.add('hidden');
            document.getElementById('quest-modal').classList.add('hidden');
            document.getElementById('top-bar').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
            currentQuestionNumber = 0;
        }

        function confirmExit() {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (currentQuestionNumber > 0 && currentQuestionNumber <= TOTAL_QUESTIONS) {
                if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏≠‡∏¢‡∏π‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
                    showStart();
                    closeQuest(); // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏¥‡∏î Modal
                }
            } else {
                showStart();
                closeQuest();
            }
        }

        function startMission(level) {
            currentQuestionNumber = 0;
            currentScore = 0;
            document.getElementById('score-display').innerText = "0";
            document.getElementById('progress-container').classList.remove('hidden');
            generateQuest(level);
        }

        async function generateQuest(level) {
            lastLevel = level;
            currentQuestionNumber++;
            
            updateProgress();

            const modal = document.getElementById('quest-modal');
            const card = document.getElementById('quest-card');
            const successView = document.getElementById('success-view');
            const missionCompleteView = document.getElementById('mission-complete-view');
            const loading = document.getElementById('quest-loading');
            const content = document.getElementById('quest-content');
            
            modal.classList.remove('hidden');
            card.classList.remove('hidden');
            successView.classList.add('hidden');
            missionCompleteView.classList.add('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            document.getElementById('hint-box').classList.add('hidden');

            const prompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡∏≠‡∏á NEAY1 ‡∏à‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå 1 ‡∏Ç‡πâ‡∏≠ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö ${level} 
            ‡∏ï‡∏≤‡∏° "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏Å‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä 2551 (‡∏â‡∏ö‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)" 
            ‡∏™‡∏∏‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤: ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå, ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢, ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (‡∏´‡πâ‡∏≤‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå)
            ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô JSON:
            {
                "title": "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡πâ‡∏ô‡πÜ",
                "question": "‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢",
                "options": ["‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå 1", "‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå 2", "‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå 3", "‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå 4"],
                "correctIndex": 0,
                "encouragement": "‡∏Ñ‡∏≥‡∏ä‡∏°‡πÄ‡∏ä‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ",
                "subject": "‡∏ß‡∏¥‡∏ä‡∏≤",
                "icon": "emoji ‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤"
            }`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                currentQuestData = JSON.parse(data.candidates[0].content.parts[0].text);

                document.getElementById('subject-icon').innerText = currentQuestData.icon || 'üéØ';
                document.getElementById('quest-title').innerText = `${currentQuestData.title} (${currentQuestionNumber}/${TOTAL_QUESTIONS})`;
                document.getElementById('quest-body').innerText = currentQuestData.question;
                
                const optionsDiv = document.getElementById('quest-options');
                optionsDiv.innerHTML = '';
                currentQuestData.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full p-4 text-left border-2 border-gray-100 rounded-2xl hover:border-blue-500 hover:bg-blue-50 transition font-medium text-gray-700";
                    btn.innerText = opt;
                    btn.onclick = () => handleAnswer(idx === currentQuestData.correctIndex, currentQuestData.encouragement);
                    optionsDiv.appendChild(btn);
                });

                loading.classList.add('hidden');
                content.classList.remove('hidden');
            } catch (error) {
                console.error(error);
                closeQuest();
            }
        }

        function updateProgress() {
            const percent = (currentQuestionNumber / TOTAL_QUESTIONS) * 100;
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${currentQuestionNumber}/${TOTAL_QUESTIONS}`;
        }

        async function handleAnswer(isCorrect, encouragement) {
            if (isCorrect) {
                currentScore += 10;
                document.getElementById('score-display').innerText = currentScore;
                document.getElementById('quest-card').classList.add('hidden');
                
                if (currentQuestionNumber >= TOTAL_QUESTIONS) {
                    showMissionComplete();
                } else {
                    document.getElementById('success-view').classList.remove('hidden');
                    document.getElementById('success-encouragement').innerText = encouragement;
                    generateAIStory();
                    document.getElementById('next-quest-btn').onclick = () => generateQuest(lastLevel);
                }
            } else {
                alert("‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß! ‡∏•‡∏≠‡∏á‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏î‡∏π‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏ô‡∏∞ ‡∏û‡∏µ‡πà AI ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏î‡πâ ‚ú®");
            }
        }

        async function showMissionComplete() {
            document.getElementById('success-view').classList.add('hidden');
            document.getElementById('mission-complete-view').classList.remove('hidden');
            document.getElementById('final-score-display').innerText = currentScore;
            
            const summaryBox = document.getElementById('ai-summary-feedback');
            summaryBox.innerText = "‡∏û‡∏µ‡πà AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏ä‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì...";

            const prompt = `‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö ${lastLevel} ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ñ‡∏£‡∏ö 20 ‡∏Ç‡πâ‡∏≠ ‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏™‡∏°‡πÑ‡∏î‡πâ ${currentScore} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 
            ‡∏à‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏ä‡∏°‡πÄ‡∏ä‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡∏á‡∏ö‡∏±‡∏ô‡∏î‡∏≤‡∏•‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏≤‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏à‡∏î‡∏µ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ 2-3 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ)`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                summaryBox.innerText = data.candidates[0].content.parts[0].text;
            } catch (err) {
                summaryBox.innerText = "‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏à‡∏ô‡∏Ñ‡∏£‡∏ö 20 ‡∏Ç‡πâ‡∏≠ ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á!";
            }
        }

        async function getAIHint() {
            if (!currentQuestData) return;
            const hintBox = document.getElementById('hint-box');
            hintBox.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏≤‡∏°‡∏û‡∏µ‡πà AI...";
            hintBox.classList.remove('hidden');
            const prompt = `‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡πÄ‡∏î‡πá‡∏Å ${lastLevel} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå: ${currentQuestData.question} (‡∏ß‡∏¥‡∏ä‡∏≤ ${currentQuestData.subject}) ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏â‡∏•‡∏¢`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                hintBox.innerText = "‚ú® " + data.candidates[0].content.parts[0].text;
            } catch (err) { hintBox.innerText = "‡∏•‡∏≠‡∏á‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡∏≠‡πà‡∏≤‡∏ô‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏î‡∏π‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞"; }
        }

        async function generateAIStory() {
            const storyBox = document.getElementById('ai-story-box');
            const storyText = document.getElementById('ai-story-text');
            storyBox.classList.remove('hidden');
            storyText.innerText = "‡πÅ‡∏ï‡πà‡∏á‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏à‡πâ‡∏≤...";
            const prompt = `‡πÅ‡∏ï‡πà‡∏á‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏à‡∏¥‡πã‡∏ß 2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏à‡∏≤‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ ${currentQuestData.subject} ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πá‡∏Å ${lastLevel}`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                storyText.innerText = data.candidates[0].content.parts[0].text;
            } catch (err) { storyBox.classList.add('hidden'); }
        }

        function closeQuest() { document.getElementById('quest-modal').classList.add('hidden'); }
        function openChat() { document.getElementById('ai-chat').classList.remove('hidden'); }
        function closeChat() { document.getElementById('ai-chat').classList.add('hidden'); }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const messages = document.getElementById('chat-messages');
            const loader = document.getElementById('chat-loading-indicator');
            const text = input.value.trim();
            if (!text) return;

            const userMsg = document.createElement('div');
            userMsg.className = "bg-gray-100 p-3 rounded-2xl rounded-tr-none text-gray-800 self-end ml-8";
            userMsg.innerText = text;
            messages.appendChild(userMsg);
            input.value = '';
            messages.scrollTop = messages.scrollHeight;
            loader.classList.remove('hidden');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå NEAY1 ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${text}` }] }]
                    })
                });
                const data = await response.json();
                loader.classList.add('hidden');
                const aiMsg = document.createElement('div');
                aiMsg.className = "bg-blue-100 p-3 rounded-2xl rounded-tl-none text-blue-800 mr-8";
                aiMsg.innerText = data.candidates[0].content.parts[0].text;
                messages.appendChild(aiMsg);
                messages.scrollTop = messages.scrollHeight;
            } catch (err) { loader.classList.add('hidden'); }
        }
    </script>
</body>
</html>